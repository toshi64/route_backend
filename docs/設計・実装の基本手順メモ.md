

# 🧭 設計・実装の基本手順（Django・Pythonプロジェクト向け）

---

## 🎯 ゴール

**複雑な処理を明快に分解し、再利用・検証しやすい形で構築する**。  
この手法は特に、API連携やLLM処理、外部データベースを含むシステムにおいて効果的です。

---

## 🛠 開発の4ステップ

---

### ✅ ① 設計図を組む（役割に応じた関数分類）

処理を3つのカテゴリに分けて設計する：

| 種類 | 説明 | 例 |
|------|------|----|
| 🧪 **純粋関数** | 入力 → 出力が常に同じ。副作用なし | プロンプト生成、テキスト変換、文字列整形 |
| 💾 **副作用のある関数** | DB保存、ファイル書き込み、API呼び出しなど | Supabaseへの保存、ChatGPT API呼び出し |
| 🧭 **制御スコープ関数** | 上記の関数を順序よく呼び出し、全体の流れを制御する | `generate_and_save_material()` など |

🔸 設計時点では「**関数の粒度**」「**入出力の構造**」「**戻り値 or 副作用**」を明確に区別することが重要。

---

### ✅ ② 純粋関数を作る（ロジック単位）

- テストしやすく、ローカル変数だけで完結するように設計
- 同じ入力なら常に同じ出力を返す関数にする

```python
def generate_prompt(raw_data: dict) -> str:
    return f"以下の情報に基づいて英文を生成してください：\n{raw_data}"
```

---

### ✅ ③ 副作用のある関数を作る（外部連携処理）

- DB保存、API呼び出し、ファイル入出力などを行う
- エラー処理・ログ出力もこの中で行う

```python
def save_to_supabase(material_dict: dict):
    Material.objects.create(**material_dict)
```

---

### ✅ ④ 制御スコープにまとめる（工程のオーケストレーション）

- 純粋関数と副作用関数を「順番に呼び出す」関数
- 状態遷移・例外処理・デバッグプリントなどもここに集約

```python
def generate_and_save_material(raw_data: dict):
    prompt = generate_prompt(raw_data)
    output = call_chatgpt(prompt)
    material = format_output(output, raw_data)
    save_to_supabase(material)
```

---

## 🧠 この構造のメリット

- **読みやすく、ロジックの責任が明確**
- **純粋関数を単体テストで検証しやすい**
- **副作用は制御スコープに隔離でき、追跡・デバッグしやすい**
- **関数の再利用性と差し替え性が高い**

---

## 🔚 補足

この構造は関数型プログラミングやクリーンアーキテクチャの影響を受けた構成で、  
**LLMプロンプト生成 × API連携 × DB保存**などが絡む現代的なPythonアプリに特に有効です。

---

